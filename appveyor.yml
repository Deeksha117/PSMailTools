version: 1.0.0.{build}
skip_tags: true
os: WMF 5
build: off

branches:
  only:
    - master
    - development
    - v0.2.0

skip_commits:
    message: /skip\-tests/
    files:
        - .github/
        - .vscode/
        - README.md
        - .gitattributes
        - .gitignore
        - .env*

pull_requests:
  do_not_increment_build_number: true

install:
  - ps: |
      Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force | Out-Null
      Install-Module Pester -MinimumVersion 4.3.1 -Scope CurrentUser -Force | Out-Null
      Install-Module psake -Scope CurrentUser -Force | Out-Null
      Install-Module PSScriptAnalyzer -Scope CurrentUser -Force | Out-Null
      Install-Module platyPS -Scope CurrentUser -Force | Out-Null
      PowerShell.exe -Command { Export-Clixml -InputObject $Profile -Path  $env:temp\PSProfile.xml }

build_script:
  - ps: |
      $Profile = Import-Clixml $env:temp\PSProfile.xml
      $testResultsFile = ".\TestResults.xml"
      Invoke-psake -buildFile ".\build.psake.ps1" -taskList Test -properties @{"TestOutputFile" = $testResultsFile}
      if ($psake.build_success -and (Test-Path $testResultsFile)) {
          (New-Object 'System.Net.WebClient').UploadFile("https://ci.appveyor.com/api/testresults/nunit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path $testResultsFile))
      }
      else {
          # Terminate the script to fail the build
          $Error | Format-List * -Force
          exit 1;
      }

on_finish:
    - ps: |
        # Publish the contents of the Release folder
        Set-Location $env:APPVEYOR_BUILD_FOLDER
        Add-Type -assemblyname System.IO.Compression.FileSystem
        $stagingDirectory = (Resolve-Path ..).Path
        $zipPath = Join-Path $stagingDirectory "PSMailTools-$($env:APPVEYOR_REPO_BRANCH).zip"
        [System.IO.Compression.ZipFile]::CreateFromDirectory(".\Release", $zipPath)
        Push-AppveyorArtifact $zipPath